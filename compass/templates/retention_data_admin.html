{% extends 'supporttools/base.html' %}
{% load static %}

{% block content %}
  <h1>Retention Analytics Data Admin</h1>
  <h2>Canvas Analytics Data </h2>
  <p>Compass jobs that fetch data from the Canvas Analytics GCS Bucket</p>
  <p>Runs weekly at 20:00 Sunday PST (04:00 Monday UTC), imports most recent week in bucket if it has not been imported already</p>
  <p><strong>Reload:</strong> Removes the selected week's data from Compass and attempts to re-import from Canvas Analytics</p>
  <p><strong>Delete:</strong> Removes the selected week's data from Compass, if most recent week deleted, alert status will need to be re-calculated</p>
  <p><em>Both of these actions have user facing impacts, if 'good' data is removed and not replaced users will be missing data</em></p>
  <table id="canvas_analytics_table" class="table nowrap">
    <thead>
      <tr>
        <th hidden>key</th>
        <th>Import ID</th>
        <th>Year</th>
        <th>Quarter</th>
        <th>Week</th>
        <th>Import Date</th>
        <th>Last Processed </th>
        <th>Status</th>
        <th>Students With Scores</th>
        <th>Canvas Scores Imported</th>
        <th>Signin Scores Imported</th>
        <th>Reload</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody>
    {% for import in imports %}
      <tr>
        <td hidden>{{ import.week.key }}</td>
        <td>{{ import.id }}</td>
        <td>{{ import.week.year }}</td>
        <td>{{ import.week.quarter }}</td>
        <td>{{ import.week.week }}</td>
        <td>{{ import.created_date }}</td>
        <td>{{ import.processed_date }}</td>
        <td>{{ import.get_import_status_display }}</td>
        <td>{{ import.student_count }}</td>
        <td>{{ import.total_scores }}</td>
        <td>{{ import.signin_scores }}</td>
        <td><button class="reload-btn" value="{{ import.id }}">Reload</button></td>
        <td><button class="delete-btn" value="{{ import.id }}">Delete</button></td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  <h2>Student Alert Status</h2>
  <p>Calculates student alert status (colored rings) from per-course predictions, uses the most recently imported week</p>
  <p>This is automatically run when data is loaded/reloaded and always builds alerts from the most recent analytics data in Compass</p>
  <p><strong>Current alerts generated from week: </strong>
    {% if alert_data.source_week %}
    {{ alert_data.source_week.year }}-{{ alert_data.source_week.quarter }}-week-{{ alert_data.source_week.week }}
    {% else %}
    No alerts calculated yet
    {% endif %}
  </p>
  <button id="reload_alerts_btn">Calculate alerts from {{ alert_data.current_week.year }}-{{ alert_data.current_week.quarter }}-week-{{ alert_data.current_week.week }}</button>
  <p><em>Manually running this should rarely be needed, only if the current week was deleted or a transient error prevented automatic alert generation</em></p>
  {% if alert_data.source_week %}
  <table id="prediction_table" class="table">
    <thead>
    <tr>
      <th>Students With Alert</th>
      <th>Total Success</th>
      <th>Total Warning</th>
      <th>Total Failure</th>
    </tr>
    </thead>
    <tbody>
    <tr>
      <td>{{ alert_data.total_alerts }}</td>
      <td>{{ alert_data.total_success }}</td>
      <td>{{ alert_data.total_warning }}</td>
      <td>{{ alert_data.total_danger }}</td>
    </tr>
    </tbody>
  </table>
  {% else %}
    <p>No prediction data loaded.</p>
  {% endif %}
  <h2>Canvas Analytics Files</h2>
    <p>List of files in Canvas Analytics GCS bucket, Compas imports data from these files</p>
    <p>Generated weekly by Canvas Analytics project at 06:00 Sunday PST (14:00 Sunday UTC)</p>
    <p><strong>Associated Import ID:</strong>The Compass Import ID (see table at top) for the file, "Not Imported" if data not in Compass</p>
    <p><strong>Reload:</strong>  Will attempt to load or reload the specified data file in Compass, useful if Compass hasn't attempted an import for that week</p>
    {% if file_data %}
    <table id="canvas_analytics_files_table" class="table nowrap">
      <thead>
        <tr>
          <th hidden>Key</th>
          <th>File Name</th>
          <th>Associated Import ID</th>
          <th>Reload</th>
        </tr>
      </thead>
      <tbody>
      {% for file in file_data %}
        <tr>
          <td hidden>{{ file.week_key }}</td>
          <td>{{ file.filename }}</td>
          <td>{{ file.import_id }}</td>
          <td><button class="reload-file-btn" value="{{ file.week_string }}">Reload</button></td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>Cannot load files list from GCS bucket.</p>
  {% endif %}

  <script src="{% static 'compass/js/vendor/jquery-3.7.1.min.js' %}"></script>
  <link href="https://cdn.datatables.net/v/bs5/dt-2.3.4/datatables.min.css" rel="stylesheet" integrity="sha384-i0jVPhw/X00l5EPvMOBv0lcGYXlSQGOqNYpMK/406rxta9oBump0IZJIHzvtf3+H" crossorigin="anonymous">

  <script src="https://cdn.datatables.net/v/bs5/dt-2.3.4/datatables.min.js" integrity="sha384-jVoHjtunWKmr2zpSki5PSXfFYRsTQQm1uk4wpf45zuYxast668XkB2fJL8PjloNc" crossorigin="anonymous"></script>
  <script src="{% static 'compass/js/retention_data_admin.js' %}"></script>
{% endblock content %}
